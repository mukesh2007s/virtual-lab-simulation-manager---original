<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Performance Dashboard</title>
    <link rel="stylesheet" href="/style.css">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

    <nav class="sidebar">
        <div class="brand"><i class='bx bx-atom'></i> Virtual Lab</div>
        <ul class="nav-menu">
            <li class="nav-item"><a href="/student_menu" class="nav-link"><i class='bx bx-grid-alt'></i> Dashboard</a></li>
            <li class="nav-item"><a href="/lectures" class="nav-link"><i class='bx bx-video'></i> Lectures</a></li>
            <li class="nav-item"><a href="/materials" class="nav-link"><i class='bx bx-book-open'></i> Materials</a></li>
            <li class="nav-item"><a href="/quiz" class="nav-link"><i class='bx bx-brain'></i> Quizzes</a></li>
            <li class="nav-item"><a href="/tests" class="nav-link"><i class='bx bx-edit-alt'></i> Tests</a></li>
            <li class="nav-item"><a href="/dashboard" class="nav-link active"><i class='bx bx-bar-chart-alt-2'></i> Performance</a></li>
            <li class="nav-item"><a href="/feedback" class="nav-link"><i class='bx bx-message-square-dots'></i> Feedback</a></li>
            <li class="nav-item"><a href="/profile" class="nav-link"><i class='bx bx-user-circle'></i> My Profile</a></li>
        </ul>
        <div class="user-profile">
            <a href="/logout" class="logout-btn"><i class='bx bx-log-out'></i> Sign Out</a>
        </div>
    </nav>

    <main class="main-content">
        
        <div class="page-header">
            <h1 class="page-title">Performance Analytics</h1>
            <p class="page-subtitle" id="welcome-msg">Loading your stats...</p>
        </div>

        <div class="grid" style="margin-bottom: 2rem;">
            <div class="card" style="border-left: 5px solid var(--primary);">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <p style="color:var(--text-muted); font-size:0.9rem; margin:0;">Total Quizzes</p>
                        <h2 id="total-quizzes" style="font-size:2rem; margin:5px 0;">0</h2>
                    </div>
                    <div style="font-size:2.5rem; color:var(--primary); opacity:0.2;"><i class='bx bx-book-open'></i></div>
                </div>
            </div>

            <div class="card" style="border-left: 5px solid var(--success);">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <p style="color:var(--text-muted); font-size:0.9rem; margin:0;">Average Score</p>
                        <h2 id="avg-score" style="font-size:2rem; margin:5px 0;">0%</h2>
                    </div>
                    <div style="font-size:2.5rem; color:var(--success); opacity:0.2;"><i class='bx bx-trending-up'></i></div>
                </div>
            </div>

            <div class="card" style="border-left: 5px solid #f59e0b;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <p style="color:var(--text-muted); font-size:0.9rem; margin:0;">Latest Activity</p>
                        <h2 id="latest-topic" style="font-size:1.2rem; margin:12px 0;">-</h2>
                    </div>
                    <div style="font-size:2.5rem; color:#f59e0b; opacity:0.2;"><i class='bx bx-time-five'></i></div>
                </div>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1.5fr 1fr; gap: 1.5rem; align-items: start;">
            
            <div class="card">
                <h3><i class='bx bx-line-chart'></i> Score History</h3>
                <div style="height: 300px; position: relative;">
                    <canvas id="performanceChart"></canvas>
                </div>
            </div>

            <div class="card">
                <h3><i class='bx bx-list-ul'></i> Recent Results</h3>
                <div style="overflow-y: auto; max-height: 300px;">
                    <table style="width:100%; border:none;">
                        <tbody id="scoreTable">
                            <tr><td style="text-align:center; color:gray;">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </main>

    <script>
        fetch('/getdashboarddata')
            .then(res => res.json())
            .then(data => {
                // 1. Update Header
                document.getElementById('welcome-msg').innerText = `Overview for ${data.fullName}`;

                const scores = data.recentScores;
                
                // 2. Update Summary Cards
                document.getElementById('total-quizzes').innerText = scores.length;
                
                if(scores.length > 0) {
                    // Calculate Average
                    let totalPercent = 0;
                    scores.forEach(s => totalPercent += (s.score / s.total));
                    let avg = Math.round((totalPercent / scores.length) * 100);
                    document.getElementById('avg-score').innerText = avg + "%";
                    
                    // Latest Topic
                    let last = scores[0]; // Provided backend sorts DESC
                    document.getElementById('latest-topic').innerText = last.topic.charAt(0).toUpperCase() + last.topic.slice(1);
                }

                // 3. Populate Table
                const tableBody = document.getElementById('scoreTable');
                tableBody.innerHTML = "";
                
                if (scores.length === 0) {
                    tableBody.innerHTML = "<tr><td colspan='2' style='text-align:center; padding:20px;'>No quizzes taken yet.</td></tr>";
                } else {
                    scores.forEach(s => {
                        // Logic for Badge Color
                        let percent = (s.score / s.total);
                        let badgeColor = percent >= 0.8 ? '#dcfce7' : (percent >= 0.5 ? '#fef9c3' : '#fee2e2');
                        let textColor = percent >= 0.8 ? '#166534' : (percent >= 0.5 ? '#854d0e' : '#991b1b');
                        let label = percent >= 0.8 ? 'Great' : (percent >= 0.5 ? 'Average' : 'Low');

                        let row = `
                        <tr>
                            <td>
                                <div style="font-weight:600;">${s.topic.charAt(0).toUpperCase() + s.topic.slice(1)}</div>
                                <div style="font-size:0.85rem; color:#6b7280;">Score: ${s.score}/${s.total}</div>
                            </td>
                            <td style="text-align:right;">
                                <span style="background:${badgeColor}; color:${textColor}; padding:4px 8px; border-radius:12px; font-size:0.75rem; font-weight:700;">${label}</span>
                            </td>
                        </tr>`;
                        tableBody.innerHTML += row;
                    });
                }

                // 4. Render Chart
                renderChart(scores);
            });

        function renderChart(scores) {
            const ctx = document.getElementById('performanceChart').getContext('2d');
            
            // Reverse scores so chart goes Left(Old) -> Right(New)
            // But only if backend sends New -> Old. Assuming standard timeline.
            const chartData = [...scores].reverse(); 

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartData.map(s => s.topic.charAt(0).toUpperCase() + s.topic.slice(1)),
                    datasets: [{
                        label: 'Score',
                        data: chartData.map(s => s.score),
                        borderColor: '#6366f1',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: '#ffffff',
                        pointBorderColor: '#6366f1',
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, max: 5, grid: { color: '#f3f4f6' } },
                        x: { grid: { display: false } }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }
    </script>

</body>
</html>