<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Teacher Dashboard</title>
    <link rel="stylesheet" href="/style.css">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Toggle Views */
        .view-section { display: none; }
        .view-section.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
        
        /* --- RESTORED: Old Style Stats Cards --- */
        .stat-card {
            background: white; border: 1px solid var(--border); 
            border-radius: 12px; padding: 20px;
            text-align: center; box-shadow: var(--shadow-sm);
            transition: transform 0.2s;
        }
        .stat-card:hover { transform: translateY(-3px); border-color: var(--primary); }
        .stat-number { font-size: 2rem; font-weight: 800; color: var(--primary); margin: 10px 0; }
        .stat-label { color: var(--text-muted); font-size: 0.9rem; font-weight: 600; text-transform: uppercase; }

        /* --- RESTORED: Filter Bar --- */
        .filter-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            padding: 15px;
            border-radius: 12px;
            border: 1px solid var(--border);
            margin-bottom: 20px;
            box-shadow: var(--shadow-sm);
        }
        .student-select {
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--border);
            font-size: 1rem;
            min-width: 250px;
            outline: none;
        }

        /* Modal Styles (For Edit Student) */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-box { background: white; padding: 2rem; border-radius: 12px; width: 400px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); position: relative; }
        .close-btn { position: absolute; top: 10px; right: 15px; font-size: 1.5rem; cursor: pointer; color: #666; }
        .close-btn:hover { color: var(--danger); }

        /* Feedback Badge */
        .feedback-badge {
            background: #ef4444;
            color: white;
            font-size: 0.7rem;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 5px;
        }
        .feedback-card {
            background: white;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.2s;
        }
        .feedback-card.unread {
            border-left: 4px solid #4f46e5;
            background: #f8fafc;
        }
        .feedback-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .feedback-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }
        .feedback-subject {
            font-weight: 700;
            color: var(--text);
            font-size: 1.05rem;
        }
        .feedback-meta {
            font-size: 0.8rem;
            color: var(--text-muted);
        }
        .feedback-message {
            color: var(--text);
            line-height: 1.6;
            margin: 10px 0;
            padding: 10px;
            background: #f8fafc;
            border-radius: 8px;
        }
        .feedback-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
    </style>
</head>
<body>

    <nav class="sidebar">
        <div class="brand"><i class='bx bxs-school'></i> Teacher</div>
        <ul class="nav-menu">
            <li class="nav-item"><a href="#" onclick="switchView('roster')" id="nav-roster" class="nav-link active"><i class='bx bx-user-plus'></i> Students</a></li>
            <li class="nav-item"><a href="#" onclick="switchView('performance')" id="nav-performance" class="nav-link"><i class='bx bx-line-chart'></i> Progress</a></li>
            <li class="nav-item"><a href="#" onclick="switchView('quiz')" id="nav-quiz" class="nav-link"><i class='bx bx-edit'></i> Manage Quiz</a></li>
            <li class="nav-item"><a href="#" onclick="switchView('lectures')" id="nav-lectures" class="nav-link"><i class='bx bx-video'></i> Lectures</a></li>
            <li class="nav-item"><a href="#" onclick="switchView('materials')" id="nav-materials" class="nav-link"><i class='bx bx-book-open'></i> Materials</a></li>
            <li class="nav-item"><a href="#" onclick="switchView('feedback')" id="nav-feedback" class="nav-link"><i class='bx bx-message-square-dots'></i> Feedback <span id="feedbackBadge" class="feedback-badge" style="display:none;"></span></a></li>
            <li class="nav-item"><a href="#" onclick="switchView('tests')" id="nav-tests" class="nav-link"><i class='bx bx-edit-alt'></i> Tests</a></li>
            <li class="nav-item"><a href="/profile" class="nav-link"><i class='bx bx-user-circle'></i> Profile</a></li>
        </ul>
        <div class="user-profile"><a href="/logout" class="logout-btn">Sign Out</a></div>
    </nav>

    <main class="main-content">

        <div id="view-roster" class="view-section active">
            <h1 class="page-title">Class Management</h1>
            <div class="grid" style="margin-bottom: 2rem;">
                <div class="card">
                    <h3><i class='bx bx-user-plus'></i> Add Student</h3>
                    <form action="/api/teacher/addstudent" method="POST" style="margin-top: 15px;">
                        <input type="text" name="username" placeholder="Username" required>
                        <input type="text" name="password" placeholder="Password" required>
                        <input type="text" name="fullName" placeholder="Full Name" required>
                        <button type="submit">Create Account</button>
                    </form>
                </div>
                <div class="card">
                    <h3><i class='bx bx-envelope'></i> Admin Support</h3>
                    <form action="/api/teacher/feedback" method="POST">
                        <textarea name="message" rows="4" placeholder="Message..."></textarea>
                        <button type="submit" style="background-color: #475569;">Send</button>
                    </form>
                </div>
            </div>
            <div class="card">
                <h3>Student Roster</h3>
                <table id="studentTable"><thead><tr><th>Username</th><th>Name</th><th style="text-align:center;">Actions</th></tr></thead><tbody></tbody></table>
            </div>
        </div>

        <div id="view-performance" class="view-section">
            <div class="page-header">
                <h1 class="page-title">Student Progress</h1>
                <p class="page-subtitle">Track individual performance and class averages.</p>
            </div>

            <div class="filter-bar">
                <div style="font-weight: 600; color: var(--text-muted);">
                    <i class='bx bx-filter-alt'></i> Filter View:
                </div>
                <select id="studentSelector" class="student-select" onchange="filterDashboard()">
                    <option value="all">Show All Students (Class Average)</option>
                </select>
            </div>

            <div class="grid" style="grid-template-columns: repeat(3, 1fr); margin-bottom: 2rem;">
                <div class="stat-card">
                    <div class="stat-label">Total Quizzes Taken</div>
                    <div class="stat-number" id="total-attempts">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label" id="avg-label">Class Average</div>
                    <div class="stat-number" id="class-average">0%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Top Subject</div>
                    <div class="stat-number" id="top-subject" style="font-size: 1.5rem; color: #10b981;">-</div>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1.5fr; gap: 1.5rem; align-items: start;">
                
                <div class="card">
                    <h3><i class='bx bx-pie-chart-alt-2'></i> Average by Topic</h3>
                    <div style="height: 250px; position: relative;">
                        <canvas id="classChart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <h3><i class='bx bx-list-check'></i> Recent Activity Log</h3>
                    <div style="max-height: 300px; overflow-y: auto;">
                        <table id="performanceTable">
                            <thead><tr><th>Student</th><th>Topic</th><th>Score</th><th>Date</th></tr></thead>
                            <tbody id="perfBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-lectures" class="view-section">
            <h1 class="page-title">Manage Lecture Videos</h1>
            
            <!-- Upload Method Tabs -->
            <div class="upload-tabs" style="display:flex; gap:10px; margin-bottom:1.5rem;">
                <button class="upload-tab active" onclick="switchUploadMethod('url')" id="tab-url" style="padding:10px 20px; border:1px solid var(--border); background:var(--primary); color:white; border-radius:8px; cursor:pointer; font-weight:600;">
                    <i class='bx bx-link'></i> URL Link
                </button>
                <button class="upload-tab" onclick="switchUploadMethod('file')" id="tab-file" style="padding:10px 20px; border:1px solid var(--border); background:white; color:var(--text); border-radius:8px; cursor:pointer; font-weight:600;">
                    <i class='bx bx-upload'></i> Upload from Device
                </button>
            </div>

            <div class="grid" style="margin-bottom: 2rem;">
                <!-- URL Upload Form -->
                <div class="card" id="upload-url">
                    <h3><i class='bx bx-link'></i> Add Video via URL</h3>
                    <form action="/api/teacher/add_lecture" method="POST" style="margin-top: 15px;">
                        <input type="text" name="title" placeholder="Lecture Title" required>
                        <textarea name="summary" rows="3" placeholder="Short Summary (max 200 chars)" maxlength="200" required></textarea>
                        <input type="url" name="videoUrl" placeholder="Video URL (YouTube, Vimeo, etc.)" required>
                        <select name="category" required style="padding:10px; border:1px solid #e2e8f0; border-radius:8px; margin-bottom:10px;">
                            <option value="">Select Category</option>
                            <option value="Physics">Physics</option>
                            <option value="Chemistry">Chemistry</option>
                            <option value="Engineering">Engineering</option>
                            <option value="General">General</option>
                        </select>
                        <button type="submit">Add Lecture</button>
                    </form>
                </div>

                <!-- File Upload Form -->
                <div class="card" id="upload-file" style="display:none;">
                    <h3><i class='bx bx-upload'></i> Upload Video from Device</h3>
                    <form id="videoUploadForm" enctype="multipart/form-data" style="margin-top: 15px;">
                        <input type="text" name="title" id="file-title" placeholder="Lecture Title" required>
                        <textarea name="summary" id="file-summary" rows="3" placeholder="Short Summary (max 200 chars)" maxlength="200" required></textarea>
                        <select name="category" id="file-category" required style="padding:10px; border:1px solid #e2e8f0; border-radius:8px; margin-bottom:10px;">
                            <option value="">Select Category</option>
                            <option value="Physics">Physics</option>
                            <option value="Chemistry">Chemistry</option>
                            <option value="Engineering">Engineering</option>
                            <option value="General">General</option>
                        </select>
                        <div class="file-drop-zone" id="dropZone" style="border:2px dashed var(--border); border-radius:12px; padding:30px; text-align:center; cursor:pointer; transition:all 0.3s; margin-bottom:10px;">
                            <i class='bx bx-cloud-upload' style="font-size:3rem; color:var(--primary); opacity:0.7;"></i>
                            <p style="color:var(--text-muted); margin:10px 0 5px;">Drag & drop video file here or click to browse</p>
                            <p style="color:var(--text-muted); font-size:0.8rem;">Supported: MP4, WebM, MOV, AVI (Max 100MB)</p>
                            <input type="file" name="videoFile" id="videoFileInput" accept="video/*" style="display:none;" required>
                        </div>
                        <div id="selectedFile" style="display:none; background:#f0fdf4; padding:10px; border-radius:8px; margin-bottom:10px;">
                            <i class='bx bx-check-circle' style="color:#16a34a;"></i> <span id="selectedFileName"></span>
                        </div>
                        <div id="uploadProgress" style="display:none; margin-bottom:10px;">
                            <div style="background:#e5e7eb; border-radius:8px; height:8px; overflow:hidden;">
                                <div id="progressBar" style="background:var(--primary); height:100%; width:0%; transition:width 0.3s;"></div>
                            </div>
                            <p style="text-align:center; color:var(--text-muted); font-size:0.85rem; margin-top:5px;">Uploading... <span id="progressPercent">0%</span></p>
                        </div>
                        <button type="submit" id="uploadBtn">Upload Video</button>
                    </form>
                </div>

                <div class="card">
                    <h3><i class='bx bx-info-circle'></i> Instructions</h3>
                    <ul style="color: var(--text-muted); line-height: 1.8;">
                        <li><b>URL Method:</b> Paste YouTube/Vimeo links</li>
                        <li><b>Device Upload:</b> Upload MP4, WebM, MOV files</li>
                        <li>Add a clear title and brief summary</li>
                        <li>Select the appropriate category</li>
                        <li>Students can view lectures from their dashboard</li>
                    </ul>
                </div>
            </div>
            <div class="card">
                <h3><i class='bx bx-video'></i> Uploaded Lectures</h3>
                <table id="lecturesTable">
                    <thead><tr><th>Title</th><th>Category</th><th>Summary</th><th>Date</th><th style="text-align:center;">Actions</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Study Materials Section -->
        <div id="view-materials" class="view-section">
            <h1 class="page-title">Study Materials</h1>
            <div class="grid" style="margin-bottom: 2rem;">
                <div class="card">
                    <h3><i class='bx bx-upload'></i> Upload Study Material</h3>
                    <form id="materialUploadForm" enctype="multipart/form-data" style="margin-top: 15px;">
                        <input type="text" name="title" id="mat-title" placeholder="Material Title" required>
                        <textarea name="description" id="mat-description" rows="2" placeholder="Brief Description" required></textarea>
                        <select name="category" id="mat-category" required style="padding:10px; border:1px solid #e2e8f0; border-radius:8px; margin-bottom:10px;">
                            <option value="">Select Category</option>
                            <option value="Physics">Physics</option>
                            <option value="Chemistry">Chemistry</option>
                            <option value="Engineering">Engineering</option>
                            <option value="Notes">Notes</option>
                            <option value="Assignments">Assignments</option>
                            <option value="Reference">Reference</option>
                        </select>
                        <div class="file-drop-zone" id="materialDropZone" style="border:2px dashed var(--border); border-radius:12px; padding:25px; text-align:center; cursor:pointer; transition:all 0.3s; margin-bottom:10px;">
                            <i class='bx bx-file' style="font-size:2.5rem; color:var(--primary); opacity:0.7;"></i>
                            <p style="color:var(--text-muted); margin:8px 0 5px; font-size:0.95rem;">Drag & drop file here or click to browse</p>
                            <p style="color:var(--text-muted); font-size:0.75rem;">PDF, DOC, DOCX, PPT, PPTX, XLS, XLSX, TXT, Images (Max 50MB)</p>
                            <input type="file" name="materialFile" id="materialFileInput" accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.txt,.jpg,.jpeg,.png,.gif" style="display:none;" required>
                        </div>
                        <div id="selectedMaterial" style="display:none; background:#f0fdf4; padding:10px; border-radius:8px; margin-bottom:10px;">
                            <i class='bx bx-check-circle' style="color:#16a34a;"></i> <span id="selectedMaterialName"></span>
                        </div>
                        <div id="materialUploadProgress" style="display:none; margin-bottom:10px;">
                            <div style="background:#e5e7eb; border-radius:8px; height:8px; overflow:hidden;">
                                <div id="materialProgressBar" style="background:var(--primary); height:100%; width:0%; transition:width 0.3s;"></div>
                            </div>
                            <p style="text-align:center; color:var(--text-muted); font-size:0.85rem; margin-top:5px;">Uploading... <span id="materialProgressPercent">0%</span></p>
                        </div>
                        <button type="submit" id="materialUploadBtn">Upload Material</button>
                    </form>
                </div>
                <div class="card">
                    <h3><i class='bx bx-info-circle'></i> Supported Formats</h3>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
                        <div style="background:#fef3c7; padding:10px; border-radius:8px; text-align:center;">
                            <i class='bx bxs-file-pdf' style="font-size:1.5rem; color:#dc2626;"></i>
                            <p style="margin:5px 0 0; font-size:0.8rem; color:#92400e;">PDF Documents</p>
                        </div>
                        <div style="background:#dbeafe; padding:10px; border-radius:8px; text-align:center;">
                            <i class='bx bxs-file-doc' style="font-size:1.5rem; color:#2563eb;"></i>
                            <p style="margin:5px 0 0; font-size:0.8rem; color:#1e40af;">Word Documents</p>
                        </div>
                        <div style="background:#fce7f3; padding:10px; border-radius:8px; text-align:center;">
                            <i class='bx bxs-slideshow' style="font-size:1.5rem; color:#db2777;"></i>
                            <p style="margin:5px 0 0; font-size:0.8rem; color:#9d174d;">Presentations</p>
                        </div>
                        <div style="background:#dcfce7; padding:10px; border-radius:8px; text-align:center;">
                            <i class='bx bxs-spreadsheet' style="font-size:1.5rem; color:#16a34a;"></i>
                            <p style="margin:5px 0 0; font-size:0.8rem; color:#166534;">Spreadsheets</p>
                        </div>
                    </div>
                    <p style="color:var(--text-muted); font-size:0.85rem; margin-top:15px; line-height:1.6;">
                        <i class='bx bx-check' style="color:#16a34a;"></i> Students can view and download<br>
                        <i class='bx bx-check' style="color:#16a34a;"></i> Max file size: 50MB
                    </p>
                </div>
            </div>
            <div class="card">
                <h3><i class='bx bx-book-open'></i> Uploaded Materials</h3>
                <table id="materialsTable">
                    <thead><tr><th>Title</th><th>Type</th><th>Category</th><th>Size</th><th>Date</th><th style="text-align:center;">Actions</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Feedback View Section -->
        <div id="view-feedback" class="view-section">
            <div class="page-header">
                <h1 class="page-title"><i class='bx bx-message-square-dots'></i> Student Feedback</h1>
                <p class="page-subtitle">View and manage feedback submitted by students</p>
            </div>

            <div class="grid" style="grid-template-columns: repeat(3, 1fr); margin-bottom: 2rem;">
                <div class="stat-card">
                    <div class="stat-label">Total Feedback</div>
                    <div class="stat-number" id="total-feedback">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Unread</div>
                    <div class="stat-number" id="unread-feedback" style="color:#ef4444;">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Read</div>
                    <div class="stat-number" id="read-feedback" style="color:#10b981;">0</div>
                </div>
            </div>

            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h3><i class='bx bx-envelope'></i> All Feedback</h3>
                    <select id="feedbackFilter" onchange="filterFeedback()" style="padding:8px 15px; border:1px solid #e2e8f0; border-radius:8px;">
                        <option value="all">All Feedback</option>
                        <option value="unread">Unread Only</option>
                        <option value="read">Read Only</option>
                    </select>
                </div>
                <div id="feedbackContainer"></div>
                <div id="noFeedback" style="display:none; text-align:center; padding:40px; color:var(--text-muted);">
                    <i class='bx bx-message-x' style="font-size:3rem; opacity:0.5;"></i>
                    <p style="margin-top:10px;">No feedback available</p>
                </div>
            </div>
        </div>

        <div id="view-quiz" class="view-section">
            <h1 class="page-title">Manage Quiz Questions</h1>
            <div class="card" style="margin-bottom: 2rem;">
                <h3 id="form-title">Add New Question</h3>
                <form action="/api/teacher/save_question" method="POST" id="questionForm">
                    <input type="hidden" name="id" id="q-id">
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                        <select name="topic" id="q-topic" style="padding:10px; border:1px solid #e2e8f0; border-radius:8px;">
                            <option value="physics">Physics</option><option value="chemistry">Chemistry</option><option value="engineering">Engineering</option>
                        </select>
                        <input type="number" name="correctIndex" id="q-correct" placeholder="Correct Index (0-3)" min="0" max="3" required>
                    </div>
                    <input type="text" name="question" id="q-text" placeholder="Question Text" required>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                        <input type="text" name="opt0" id="q-opt0" placeholder="Option 0" required><input type="text" name="opt1" id="q-opt1" placeholder="Option 1" required>
                        <input type="text" name="opt2" id="q-opt2" placeholder="Option 2" required><input type="text" name="opt3" id="q-opt3" placeholder="Option 3" required>
                    </div>
                    <input type="text" name="explanation" id="q-expl" placeholder="Explanation" required>
                    <div style="display:flex; gap:10px;"><button type="submit" id="q-btn">Add Question</button><button type="button" onclick="resetQForm()" class="btn" style="background:#94a3b8;">Clear</button></div>
                </form>
            </div>
            <div class="card"><table id="questionsTable"><thead><tr><th>ID</th><th>Topic</th><th>Question</th><th>Action</th></tr></thead><tbody></tbody></table></div>
        </div>

        <!-- TEST MODULE SECTION -->
        <div id="view-tests" class="view-section">
            <h1 class="page-title"><i class='bx bx-edit-alt'></i> Test Management</h1>
            
            <!-- Test Sub-tabs -->
            <div style="display:flex; gap:10px; margin-bottom:1.5rem;">
                <button class="test-tab active" onclick="switchTestTab('questions')" id="test-tab-questions" style="padding:10px 20px; border:1px solid var(--border); background:var(--primary); color:white; border-radius:8px; cursor:pointer; font-weight:600;">
                    <i class='bx bx-book-content'></i> Test Questions
                </button>
                <button class="test-tab" onclick="switchTestTab('schedule')" id="test-tab-schedule" style="padding:10px 20px; border:1px solid var(--border); background:white; color:var(--text); border-radius:8px; cursor:pointer; font-weight:600;">
                    <i class='bx bx-calendar'></i> Schedule Tests
                </button>
                <button class="test-tab" onclick="switchTestTab('results')" id="test-tab-results" style="padding:10px 20px; border:1px solid var(--border); background:white; color:var(--text); border-radius:8px; cursor:pointer; font-weight:600;">
                    <i class='bx bx-bar-chart-alt-2'></i> Test Results
                </button>
            </div>

            <!-- Test Questions Tab -->
            <div id="test-questions-tab">
                <div class="grid" style="margin-bottom:2rem;">
                    <div class="card">
                        <h3 id="test-form-title"><i class='bx bx-plus-circle'></i> Add Test Question</h3>
                        <form id="testQuestionForm" style="margin-top:15px;">
                            <input type="hidden" id="tq-id">
                            <select id="tq-subject" required style="padding:10px; border:1px solid #e2e8f0; border-radius:8px; margin-bottom:10px;">
                                <option value="">Select Subject/Experiment</option>
                                <option value="Ohm's Law">Ohm's Law</option>
                                <option value="Simple Pendulum">Simple Pendulum</option>
                                <option value="Beam Deflection">Beam Deflection</option>
                                <option value="pH Scale">pH Scale</option>
                                <option value="States of Matter">States of Matter</option>
                                <option value="Gear Train">Gear Train</option>
                            </select>
                            <input type="text" id="tq-question" placeholder="Question Text" required>
                            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                                <input type="text" id="tq-opt0" placeholder="Option A" required>
                                <input type="text" id="tq-opt1" placeholder="Option B" required>
                                <input type="text" id="tq-opt2" placeholder="Option C" required>
                                <input type="text" id="tq-opt3" placeholder="Option D" required>
                            </div>
                            <select id="tq-correct" required style="padding:10px; border:1px solid #e2e8f0; border-radius:8px; margin:10px 0;">
                                <option value="">Select Correct Answer</option>
                                <option value="0">Option A</option>
                                <option value="1">Option B</option>
                                <option value="2">Option C</option>
                                <option value="3">Option D</option>
                            </select>
                            <div style="display:flex; gap:10px;">
                                <button type="submit" id="tq-btn">Add Question</button>
                                <button type="button" onclick="resetTestQForm()" style="background:#94a3b8;">Clear</button>
                            </div>
                        </form>
                    </div>
                    <div class="card">
                        <h3><i class='bx bx-info-circle'></i> Question Stats</h3>
                        <div id="questionStats" style="margin-top:15px;">
                            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                                <div style="background:#f0f9ff; padding:15px; border-radius:8px; text-align:center;">
                                    <div style="font-size:1.5rem; font-weight:700; color:#0369a1;" id="total-test-questions">0</div>
                                    <div style="font-size:0.8rem; color:#64748b;">Total Questions</div>
                                </div>
                                <div style="background:#f0fdf4; padding:15px; border-radius:8px; text-align:center;">
                                    <div style="font-size:1.5rem; font-weight:700; color:#16a34a;" id="total-subjects">0</div>
                                    <div style="font-size:0.8rem; color:#64748b;">Subjects</div>
                                </div>
                            </div>
                            <div style="margin-top:15px;">
                                <p style="font-size:0.85rem; color:#64748b; margin:5px 0;"><i class='bx bx-check'></i> Questions are randomly selected for tests</p>
                                <p style="font-size:0.85rem; color:#64748b; margin:5px 0;"><i class='bx bx-check'></i> Each test picks 10 random questions</p>
                                <p style="font-size:0.85rem; color:#64748b; margin:5px 0;"><i class='bx bx-check'></i> Students have video proctoring enabled</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <h3><i class='bx bx-list-ul'></i> All Test Questions</h3>
                        <select id="filterTestSubject" onchange="filterTestQuestions()" style="padding:8px 15px; border:1px solid #e2e8f0; border-radius:8px;">
                            <option value="all">All Subjects</option>
                            <option value="Ohm's Law">Ohm's Law</option>
                            <option value="Simple Pendulum">Simple Pendulum</option>
                            <option value="Beam Deflection">Beam Deflection</option>
                            <option value="pH Scale">pH Scale</option>
                            <option value="States of Matter">States of Matter</option>
                            <option value="Gear Train">Gear Train</option>
                        </select>
                    </div>
                    <table id="testQuestionsTable">
                        <thead><tr><th>ID</th><th>Subject</th><th>Question</th><th>Correct</th><th style="text-align:center;">Actions</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- Schedule Tests Tab -->
            <div id="test-schedule-tab" style="display:none;">
                <div class="grid" style="margin-bottom:2rem;">
                    <div class="card">
                        <h3><i class='bx bx-calendar-plus'></i> Schedule New Test</h3>
                        <form id="scheduleTestForm" style="margin-top:15px;">
                            <input type="hidden" id="sched-id">
                            <input type="text" id="sched-title" placeholder="Test Title (e.g., Midterm Exam)" required>
                            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                                <div>
                                    <label style="font-size:0.85rem; color:#64748b;">Date</label>
                                    <input type="date" id="sched-date" required style="padding:10px; border:1px solid #e2e8f0; border-radius:8px; width:100%;">
                                </div>
                                <div>
                                    <label style="font-size:0.85rem; color:#64748b;">Start Time</label>
                                    <input type="time" id="sched-time" required style="padding:10px; border:1px solid #e2e8f0; border-radius:8px; width:100%;">
                                </div>
                            </div>
                            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
                                <div>
                                    <label style="font-size:0.85rem; color:#64748b;">Duration (minutes)</label>
                                    <input type="number" id="sched-duration" value="30" min="5" max="180" required style="padding:10px; border:1px solid #e2e8f0; border-radius:8px; width:100%;">
                                </div>
                                <div>
                                    <label style="font-size:0.85rem; color:#64748b;">Number of Questions</label>
                                    <input type="number" id="sched-questions" value="10" min="1" max="50" required style="padding:10px; border:1px solid #e2e8f0; border-radius:8px; width:100%;">
                                </div>
                            </div>
                            <div style="display:flex; gap:10px; margin-top:10px;">
                                <button type="submit" id="sched-btn">Schedule Test</button>
                                <button type="button" onclick="resetScheduleForm()" style="background:#94a3b8;">Clear</button>
                            </div>
                        </form>
                    </div>
                    <div class="card">
                        <h3><i class='bx bx-info-circle'></i> Test Info</h3>
                        <div style="margin-top:15px; color:#64748b; font-size:0.9rem; line-height:1.8;">
                            <p><i class='bx bx-video' style="color:var(--primary);"></i> Video recording is mandatory for students</p>
                            <p><i class='bx bx-shuffle' style="color:var(--primary);"></i> Questions are randomly selected from bank</p>
                            <p><i class='bx bx-time' style="color:var(--primary);"></i> Test auto-submits when time expires</p>
                            <p><i class='bx bx-lock' style="color:var(--primary);"></i> Students can take each test only once</p>
                            <p><i class='bx bx-check-circle' style="color:var(--primary);"></i> Results available immediately after submission</p>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <h3><i class='bx bx-calendar-check'></i> Scheduled Tests</h3>
                    <table id="scheduledTestsTable">
                        <thead><tr><th>Title</th><th>Date</th><th>Time</th><th>Duration</th><th>Questions</th><th>Status</th><th style="text-align:center;">Actions</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- Test Results Tab -->
            <div id="test-results-tab" style="display:none;">
                <div class="grid" style="grid-template-columns: repeat(3, 1fr); margin-bottom:2rem;">
                    <div class="stat-card">
                        <div class="stat-label">Total Tests Taken</div>
                        <div class="stat-number" id="total-tests-taken">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Average Score</div>
                        <div class="stat-number" id="avg-test-score">0%</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Videos Recorded</div>
                        <div class="stat-number" id="videos-count">0</div>
                    </div>
                </div>
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <h3><i class='bx bx-bar-chart-alt-2'></i> All Test Results</h3>
                        <select id="filterTestResults" onchange="filterTestResults()" style="padding:8px 15px; border:1px solid #e2e8f0; border-radius:8px;">
                            <option value="all">All Tests</option>
                        </select>
                    </div>
                    <table id="testResultsTable">
                        <thead><tr><th>Student</th><th>Test</th><th>Score</th><th>Date</th><th>Time Taken</th><th style="text-align:center;">Video Proof</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

    </main>

    <div id="editModal" class="modal-overlay">
        <div class="modal-box">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h2 style="color:var(--primary); margin-top:0;">Edit Student</h2>
            <form action="/api/teacher/updatestudent" method="POST">
                <label style="font-weight:600; font-size:0.9rem;">Username</label>
                <input type="text" name="username" id="edit-username" readonly style="background:#f3f4f6; color:#666;">
                <label style="font-weight:600; font-size:0.9rem;">Full Name</label>
                <input type="text" name="fullName" id="edit-fullname" required>
                <label style="font-weight:600; font-size:0.9rem;">New Password</label>
                <input type="text" name="password" placeholder="Leave blank to keep current">
                <button type="submit" style="margin-top:10px;">Update Student</button>
            </form>
        </div>
    </div>

    <script>
        let globalPerfData = [];
        let globalQuestions = [];

        function switchView(view) {
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active')); document.getElementById('nav-'+view).classList.add('active');
            document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active')); document.getElementById('view-'+view).classList.add('active');
            if(view === 'roster') loadRoster();
            if(view === 'performance') loadPerformance();
            if(view === 'quiz') loadQuestions();
            if(view === 'lectures') loadLectures();
            if(view === 'materials') loadMaterials();
            if(view === 'feedback') loadStudentFeedback();
            if(view === 'tests') { loadTestQuestions(); loadScheduledTests(); loadTestResults(); }
        }

        // --- 1. ROSTER ---
        function loadRoster() {
            fetch('/api/teacher/students').then(r=>r.json()).then(data=>{
                const t = document.querySelector('#studentTable tbody'); t.innerHTML="";
                data.forEach(s => {
                    t.innerHTML += `<tr><td><span class="tag" style="background:#e0e7ff; color:#4338ca;">${s.username}</span></td><td>${s.fullName}</td>
                    <td style="text-align:center;">
                        <button onclick="openEditModal('${s.username}', '${s.fullName}')" style="padding:5px 10px; font-size:0.8rem; background:#f59e0b; margin-right:5px; width:auto; display:inline-block;">Edit</button>
                        <a href="/api/teacher/delete?username=${s.username}" style="color:var(--danger); font-weight:600;"><i class='bx bx-trash'></i> Remove</a>
                    </td></tr>`;
                });
            });
        }

        // --- 2. PERFORMANCE (Old Design Restored) ---
        function loadPerformance() {
            fetch('/api/teacher/performance').then(r=>r.json()).then(data=>{
                globalPerfData = data;
                const sel = document.getElementById('studentSelector'); sel.length=1;
                [...new Set(data.map(i=>i.student))].forEach(s => sel.innerHTML += `<option value="${s}">${s}</option>`);
                renderDashboard(data, "Class Average");
            });
        }
        function filterDashboard() {
            const val = document.getElementById('studentSelector').value;
            renderDashboard(val === 'all' ? globalPerfData : globalPerfData.filter(r => r.student === val), val === 'all' ? "Class Average" : "Student Average");
        }
        function renderDashboard(data, label) {
            const t = document.getElementById('perfBody'); t.innerHTML="";
            if(data.length===0) { t.innerHTML="<tr><td colspan='4' style='text-align:center; padding:20px;'>No data available.</td></tr>"; updateStats(0,"0%","-"); renderChart({}, {}); return; }
            
            let total=0, topics={}, counts={};
            data.forEach(r => {
                let p = r.score/r.total; total+=p;
                if(!topics[r.topic]) {topics[r.topic]=0; counts[r.topic]=0;} topics[r.topic]+=p; counts[r.topic]++;
                
                let badgeColor = p >= 0.8 ? '#dcfce7' : (p < 0.5 ? '#fee2e2' : '#fef3c7');
                let textColor = p >= 0.8 ? '#166534' : (p < 0.5 ? '#991b1b' : '#92400e');

                t.innerHTML += `<tr><td><b>${r.student}</b></td><td style="text-transform:capitalize;">${r.topic}</td><td><span style="background:${badgeColor}; color:${textColor}; padding:4px 10px; border-radius:12px; font-weight:700; font-size:0.8rem;">${r.score}/${r.total}</span></td><td style="color:#6b7280; font-size:0.85rem;">${r.date}</td></tr>`;
            });
            let bestTopic="-", bestAvg=-1; for(let k in topics) { let a=topics[k]/counts[k]; if(a>bestAvg){bestAvg=a; bestTopic=k;} }
            updateStats(data.length, Math.round((total/data.length)*100)+"%", bestTopic);
            document.getElementById('avg-label').innerText = label;
            renderChart(topics, counts);
        }
        function updateStats(t,a,top) { document.getElementById('total-attempts').innerText=t; document.getElementById('class-average').innerText=a; document.getElementById('top-subject').innerText=top; }
        function renderChart(s, c) {
            const ctx = document.getElementById('classChart').getContext('2d');
            if(window.myChart) window.myChart.destroy();
            window.myChart = new Chart(ctx, { type:'bar', data: { labels: Object.keys(s), datasets: [{ label: 'Avg %', data: Object.keys(s).map(k=>Math.round((s[k]/c[k])*100)), backgroundColor:['#6366f1','#10b981','#f59e0b'] }] }, options: { responsive:true, maintainAspectRatio:false, scales: { y: { beginAtZero:true, max:100 } } } });
        }

        // --- 3. QUIZ ---
        function loadQuestions() {
            fetch('/api/teacher/questions').then(r=>r.json()).then(data=>{
                globalQuestions = data; const t = document.querySelector('#questionsTable tbody'); t.innerHTML="";
                data.forEach(q => t.innerHTML += `<tr><td>${q.id}</td><td>${q.topic}</td><td>${q.question}</td><td><button onclick="editQ(${q.id})" style="padding:4px;">Edit</button><a href="/api/teacher/delete_question?id=${q.id}" style="color:red;margin-left:5px;">Del</a></td></tr>`);
            });
        }
        function editQ(id) { const q = globalQuestions.find(x => x.id === id); document.getElementById('q-id').value=id; document.getElementById('q-topic').value=q.topic; document.getElementById('q-text').value=q.question; document.getElementById('q-opt0').value=q.options[0]; document.getElementById('q-opt1').value=q.options[1]; document.getElementById('q-opt2').value=q.options[2]; document.getElementById('q-opt3').value=q.options[3]; document.getElementById('q-correct').value=q.correctIndex; document.getElementById('q-expl').value=q.explanation; document.getElementById('q-btn').innerText="Update"; }
        function resetQForm() { document.getElementById('questionForm').reset(); document.getElementById('q-id').value=""; document.getElementById('q-btn').innerText="Add Question"; }
        function openEditModal(u, n) { document.getElementById('edit-username').value=u; document.getElementById('edit-fullname').value=n; document.getElementById('editModal').style.display='flex'; }
        function closeModal() { document.getElementById('editModal').style.display='none'; }

        // --- 4. LECTURES ---
        function switchUploadMethod(method) {
            document.getElementById('upload-url').style.display = method === 'url' ? 'block' : 'none';
            document.getElementById('upload-file').style.display = method === 'file' ? 'block' : 'none';
            document.getElementById('tab-url').style.background = method === 'url' ? 'var(--primary)' : 'white';
            document.getElementById('tab-url').style.color = method === 'url' ? 'white' : 'var(--text)';
            document.getElementById('tab-file').style.background = method === 'file' ? 'var(--primary)' : 'white';
            document.getElementById('tab-file').style.color = method === 'file' ? 'white' : 'var(--text)';
        }

        // File upload handling
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('videoFileInput');
        const selectedFile = document.getElementById('selectedFile');
        const selectedFileName = document.getElementById('selectedFileName');

        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.style.borderColor = 'var(--primary)'; dropZone.style.background = '#f0f9ff'; });
        dropZone.addEventListener('dragleave', () => { dropZone.style.borderColor = 'var(--border)'; dropZone.style.background = 'transparent'; });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.style.borderColor = 'var(--border)';
            dropZone.style.background = 'transparent';
            if (e.dataTransfer.files.length) {
                fileInput.files = e.dataTransfer.files;
                showSelectedFile(e.dataTransfer.files[0]);
            }
        });
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length) showSelectedFile(e.target.files[0]);
        });

        function showSelectedFile(file) {
            if (file.size > 100 * 1024 * 1024) {
                alert('File too large! Maximum size is 100MB.');
                fileInput.value = '';
                return;
            }
            selectedFileName.textContent = file.name + ' (' + (file.size / (1024*1024)).toFixed(2) + ' MB)';
            selectedFile.style.display = 'block';
            dropZone.style.display = 'none';
        }

        document.getElementById('videoUploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData();
            formData.append('title', document.getElementById('file-title').value);
            formData.append('summary', document.getElementById('file-summary').value);
            formData.append('category', document.getElementById('file-category').value);
            formData.append('videoFile', fileInput.files[0]);

            document.getElementById('uploadProgress').style.display = 'block';
            document.getElementById('uploadBtn').disabled = true;
            document.getElementById('uploadBtn').textContent = 'Uploading...';

            try {
                const xhr = new XMLHttpRequest();
                xhr.upload.addEventListener('progress', (e) => {
                    if (e.lengthComputable) {
                        const percent = Math.round((e.loaded / e.total) * 100);
                        document.getElementById('progressBar').style.width = percent + '%';
                        document.getElementById('progressPercent').textContent = percent + '%';
                    }
                });
                xhr.onload = function() {
                    if (xhr.status === 200) {
                        alert('Video uploaded successfully!');
                        window.location.reload();
                    } else {
                        alert('Upload failed. Please try again.');
                        resetUploadForm();
                    }
                };
                xhr.onerror = function() {
                    alert('Upload failed. Please try again.');
                    resetUploadForm();
                };
                xhr.open('POST', '/api/teacher/upload_video');
                xhr.send(formData);
            } catch (err) {
                alert('Upload failed: ' + err.message);
                resetUploadForm();
            }
        });

        function resetUploadForm() {
            document.getElementById('uploadProgress').style.display = 'none';
            document.getElementById('uploadBtn').disabled = false;
            document.getElementById('uploadBtn').textContent = 'Upload Video';
            document.getElementById('progressBar').style.width = '0%';
        }

        function loadLectures() {
            fetch('/api/lectures').then(r=>r.json()).then(data=>{
                const t = document.querySelector('#lecturesTable tbody'); t.innerHTML="";
                if(data.length === 0) {
                    t.innerHTML = "<tr><td colspan='5' style='text-align:center; padding:20px; color:var(--text-muted);'>No lectures uploaded yet.</td></tr>";
                    return;
                }
                data.forEach(l => {
                    const isLocalVideo = l.videoUrl.startsWith('/videos/');
                    const viewLink = isLocalVideo 
                        ? `<a href="#" onclick="playVideo('${l.videoUrl}', '${l.title.replace(/'/g, "\\'")}')"; style="color:#4f46e5; font-weight:600; margin-right:10px;"><i class='bx bx-play-circle'></i> Play</a>`
                        : `<a href="${l.videoUrl}" target="_blank" style="color:#4f46e5; font-weight:600; margin-right:10px;"><i class='bx bx-link-external'></i> View</a>`;
                    t.innerHTML += `<tr>
                        <td><b>${l.title}</b></td>
                        <td><span class="tag" style="background:#e0f2fe; color:#0369a1;">${l.category}</span></td>
                        <td style="max-width:200px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" title="${l.summary}">${l.summary}</td>
                        <td style="color:#6b7280; font-size:0.85rem;">${l.date}</td>
                        <td style="text-align:center;">
                            ${viewLink}
                            <a href="/api/teacher/delete_lecture?id=${l.id}" style="color:var(--danger); font-weight:600;"><i class='bx bx-trash'></i> Delete</a>
                        </td>
                    </tr>`;
                });
            });
        }

        function playVideo(url, title) {
            const modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:9999;display:flex;align-items:center;justify-content:center;';
            modal.innerHTML = `
                <div style="background:white;border-radius:12px;padding:20px;max-width:800px;width:90%;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
                        <h3 style="margin:0;">${title}</h3>
                        <button onclick="this.closest('div').parentElement.remove()" style="background:none;border:none;font-size:1.5rem;cursor:pointer;">&times;</button>
                    </div>
                    <video controls autoplay style="width:100%;border-radius:8px;">
                        <source src="${url}" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                </div>
            `;
            modal.addEventListener('click', (e) => { if(e.target === modal) modal.remove(); });
            document.body.appendChild(modal);
        }

        // --- 5. MATERIALS ---
        const materialDropZone = document.getElementById('materialDropZone');
        const materialFileInput = document.getElementById('materialFileInput');
        const selectedMaterial = document.getElementById('selectedMaterial');
        const selectedMaterialName = document.getElementById('selectedMaterialName');

        materialDropZone.addEventListener('click', () => materialFileInput.click());
        materialDropZone.addEventListener('dragover', (e) => { e.preventDefault(); materialDropZone.style.borderColor = 'var(--primary)'; materialDropZone.style.background = '#f0f9ff'; });
        materialDropZone.addEventListener('dragleave', () => { materialDropZone.style.borderColor = 'var(--border)'; materialDropZone.style.background = 'transparent'; });
        materialDropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            materialDropZone.style.borderColor = 'var(--border)';
            materialDropZone.style.background = 'transparent';
            if (e.dataTransfer.files.length) {
                materialFileInput.files = e.dataTransfer.files;
                showSelectedMaterial(e.dataTransfer.files[0]);
            }
        });
        materialFileInput.addEventListener('change', (e) => {
            if (e.target.files.length) showSelectedMaterial(e.target.files[0]);
        });

        function showSelectedMaterial(file) {
            if (file.size > 50 * 1024 * 1024) {
                alert('File too large! Maximum size is 50MB.');
                materialFileInput.value = '';
                return;
            }
            const size = file.size < 1024 ? file.size + ' B' : 
                         file.size < 1024*1024 ? (file.size/1024).toFixed(1) + ' KB' : 
                         (file.size/(1024*1024)).toFixed(2) + ' MB';
            selectedMaterialName.textContent = file.name + ' (' + size + ')';
            selectedMaterial.style.display = 'block';
            materialDropZone.style.display = 'none';
        }

        document.getElementById('materialUploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData();
            formData.append('title', document.getElementById('mat-title').value);
            formData.append('description', document.getElementById('mat-description').value);
            formData.append('category', document.getElementById('mat-category').value);
            formData.append('materialFile', materialFileInput.files[0]);

            document.getElementById('materialUploadProgress').style.display = 'block';
            document.getElementById('materialUploadBtn').disabled = true;
            document.getElementById('materialUploadBtn').textContent = 'Uploading...';

            try {
                const xhr = new XMLHttpRequest();
                xhr.upload.addEventListener('progress', (e) => {
                    if (e.lengthComputable) {
                        const percent = Math.round((e.loaded / e.total) * 100);
                        document.getElementById('materialProgressBar').style.width = percent + '%';
                        document.getElementById('materialProgressPercent').textContent = percent + '%';
                    }
                });
                xhr.onload = function() {
                    if (xhr.status === 200) {
                        alert('Material uploaded successfully!');
                        window.location.reload();
                    } else {
                        alert('Upload failed. Please try again.');
                        resetMaterialUploadForm();
                    }
                };
                xhr.onerror = function() {
                    alert('Upload failed. Please try again.');
                    resetMaterialUploadForm();
                };
                xhr.open('POST', '/api/teacher/upload_material');
                xhr.send(formData);
            } catch (err) {
                alert('Upload failed: ' + err.message);
                resetMaterialUploadForm();
            }
        });

        function resetMaterialUploadForm() {
            document.getElementById('materialUploadProgress').style.display = 'none';
            document.getElementById('materialUploadBtn').disabled = false;
            document.getElementById('materialUploadBtn').textContent = 'Upload Material';
            document.getElementById('materialProgressBar').style.width = '0%';
        }

        function loadMaterials() {
            fetch('/api/materials').then(r=>r.json()).then(data=>{
                const t = document.querySelector('#materialsTable tbody'); t.innerHTML="";
                if(data.length === 0) {
                    t.innerHTML = "<tr><td colspan='6' style='text-align:center; padding:20px; color:var(--text-muted);'>No materials uploaded yet.</td></tr>";
                    return;
                }
                data.forEach(m => {
                    const typeIcon = getFileTypeIcon(m.fileType);
                    t.innerHTML += `<tr>
                        <td><b>${m.title}</b><br><span style="font-size:0.8rem; color:var(--text-muted);">${m.description}</span></td>
                        <td>${typeIcon}</td>
                        <td><span class="tag" style="background:#f3e8ff; color:#7c3aed;">${m.category}</span></td>
                        <td style="color:#6b7280; font-size:0.85rem;">${m.fileSize}</td>
                        <td style="color:#6b7280; font-size:0.85rem;">${m.date}</td>
                        <td style="text-align:center;">
                            <a href="${m.filePath}" target="_blank" style="color:#4f46e5; font-weight:600; margin-right:10px;"><i class='bx bx-show'></i> View</a>
                            <a href="/api/teacher/delete_material?id=${m.id}" style="color:var(--danger); font-weight:600;"><i class='bx bx-trash'></i> Delete</a>
                        </td>
                    </tr>`;
                });
            });
        }

        function getFileTypeIcon(type) {
            const icons = {
                'PDF': '<span style="background:#fee2e2; color:#dc2626; padding:4px 8px; border-radius:6px; font-size:0.75rem; font-weight:700;"><i class="bx bxs-file-pdf"></i> PDF</span>',
                'DOC': '<span style="background:#dbeafe; color:#2563eb; padding:4px 8px; border-radius:6px; font-size:0.75rem; font-weight:700;"><i class="bx bxs-file-doc"></i> DOC</span>',
                'DOCX': '<span style="background:#dbeafe; color:#2563eb; padding:4px 8px; border-radius:6px; font-size:0.75rem; font-weight:700;"><i class="bx bxs-file-doc"></i> DOCX</span>',
                'PPT': '<span style="background:#fce7f3; color:#db2777; padding:4px 8px; border-radius:6px; font-size:0.75rem; font-weight:700;"><i class="bx bxs-slideshow"></i> PPT</span>',
                'PPTX': '<span style="background:#fce7f3; color:#db2777; padding:4px 8px; border-radius:6px; font-size:0.75rem; font-weight:700;"><i class="bx bxs-slideshow"></i> PPTX</span>',
                'XLS': '<span style="background:#dcfce7; color:#16a34a; padding:4px 8px; border-radius:6px; font-size:0.75rem; font-weight:700;"><i class="bx bxs-spreadsheet"></i> XLS</span>',
                'XLSX': '<span style="background:#dcfce7; color:#16a34a; padding:4px 8px; border-radius:6px; font-size:0.75rem; font-weight:700;"><i class="bx bxs-spreadsheet"></i> XLSX</span>',
                'TXT': '<span style="background:#f3f4f6; color:#6b7280; padding:4px 8px; border-radius:6px; font-size:0.75rem; font-weight:700;"><i class="bx bx-file"></i> TXT</span>',
                'JPG': '<span style="background:#fef3c7; color:#d97706; padding:4px 8px; border-radius:6px; font-size:0.75rem; font-weight:700;"><i class="bx bxs-image"></i> JPG</span>',
                'JPEG': '<span style="background:#fef3c7; color:#d97706; padding:4px 8px; border-radius:6px; font-size:0.75rem; font-weight:700;"><i class="bx bxs-image"></i> JPEG</span>',
                'PNG': '<span style="background:#fef3c7; color:#d97706; padding:4px 8px; border-radius:6px; font-size:0.75rem; font-weight:700;"><i class="bx bxs-image"></i> PNG</span>'
            };
            return icons[type] || '<span style="background:#f3f4f6; color:#6b7280; padding:4px 8px; border-radius:6px; font-size:0.75rem; font-weight:700;"><i class="bx bx-file"></i> ' + type + '</span>';
        }

        // --- 7. STUDENT FEEDBACK ---
        let allFeedback = [];

        function loadStudentFeedback() {
            console.log('Loading student feedback...');
            fetch('/api/teacher/student_feedback')
                .then(r => {
                    console.log('Response status:', r.status);
                    return r.json();
                })
                .then(data => {
                    console.log('Feedback data:', data);
                    allFeedback = data;
                    renderFeedback(data);
                    updateFeedbackStats(data);
                })
                .catch(err => {
                    console.error('Error loading feedback:', err);
                });
        }

        function updateFeedbackStats(data) {
            const total = data.length;
            const unread = data.filter(f => f.isRead === 0).length;
            const read = total - unread;
            document.getElementById('total-feedback').textContent = total;
            document.getElementById('unread-feedback').textContent = unread;
            document.getElementById('read-feedback').textContent = read;
        }

        function renderFeedback(data) {
            const container = document.getElementById('feedbackContainer');
            const noFeedback = document.getElementById('noFeedback');
            
            if (data.length === 0) {
                container.innerHTML = '';
                noFeedback.style.display = 'block';
                return;
            }
            
            noFeedback.style.display = 'none';
            container.innerHTML = data.map(f => `
                <div class="feedback-card ${f.isRead === 0 ? 'unread' : ''}" id="feedback-${f.id}">
                    <div class="feedback-header">
                        <div>
                            <div class="feedback-subject">${f.subject}</div>
                            <div class="feedback-meta">
                                <i class='bx bx-user'></i> ${f.studentName} (${f.student}) &nbsp;&bull;&nbsp; 
                                <i class='bx bx-calendar'></i> ${f.date}
                                ${f.isRead === 0 ? '&nbsp;&bull;&nbsp; <span style="color:#ef4444; font-weight:600;"><i class=\'bx bx-envelope\'></i> New</span>' : ''}
                            </div>
                        </div>
                    </div>
                    <div class="feedback-message">${f.message}</div>
                    <div class="feedback-actions">
                        ${f.isRead === 0 ? `<button onclick="markAsRead(${f.id})" style="background:#10b981; font-size:0.85rem; padding:6px 12px;">
                            <i class='bx bx-check'></i> Mark as Read
                        </button>` : ''}
                        <button onclick="deleteFeedback(${f.id})" style="background:#ef4444; font-size:0.85rem; padding:6px 12px;">
                            <i class='bx bx-trash'></i> Delete
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function filterFeedback() {
            const filter = document.getElementById('feedbackFilter').value;
            let filtered = allFeedback;
            if (filter === 'unread') filtered = allFeedback.filter(f => f.isRead === 0);
            else if (filter === 'read') filtered = allFeedback.filter(f => f.isRead === 1);
            renderFeedback(filtered);
        }

        function markAsRead(id) {
            fetch(`/api/teacher/mark_feedback_read?id=${id}`).then(r=>r.json()).then(data=>{
                if(data.success) {
                    loadStudentFeedback();
                    loadFeedbackBadge();
                }
            });
        }

        function deleteFeedback(id) {
            if(confirm('Are you sure you want to delete this feedback?')) {
                fetch(`/api/teacher/delete_student_feedback?id=${id}`);
                document.getElementById(`feedback-${id}`).remove();
                allFeedback = allFeedback.filter(f => f.id !== id);
                updateFeedbackStats(allFeedback);
                if(allFeedback.length === 0) {
                    document.getElementById('noFeedback').style.display = 'block';
                }
                loadFeedbackBadge();
            }
        }

        function loadFeedbackBadge() {
            fetch('/api/teacher/feedback_count').then(r=>r.json()).then(data=>{
                const badge = document.getElementById('feedbackBadge');
                if(data.count > 0) {
                    badge.textContent = data.count;
                    badge.style.display = 'inline';
                } else {
                    badge.style.display = 'none';
                }
            });
        }

        // --- 8. TEST MODULE ---
        let allTestQuestions = [];
        let allScheduledTests = [];
        let allTestResults = [];

        function switchTestTab(tab) {
            // Update button styles
            document.querySelectorAll('[id^="test-tab-"]').forEach(btn => {
                btn.style.background = 'white';
                btn.style.color = 'var(--text)';
            });
            document.getElementById('test-tab-' + tab).style.background = 'var(--primary)';
            document.getElementById('test-tab-' + tab).style.color = 'white';

            // Show/hide tabs
            document.getElementById('test-questions-tab').style.display = tab === 'questions' ? 'block' : 'none';
            document.getElementById('test-schedule-tab').style.display = tab === 'schedule' ? 'block' : 'none';
            document.getElementById('test-results-tab').style.display = tab === 'results' ? 'block' : 'none';
        }

        // Test Questions Management
        function loadTestQuestions() {
            fetch('/api/test/questions').then(r => r.json()).then(data => {
                allTestQuestions = data;
                renderTestQuestions(data);
                updateQuestionStats(data);
            }).catch(err => console.error('Error loading test questions:', err));
        }

        function renderTestQuestions(data) {
            const t = document.querySelector('#testQuestionsTable tbody');
            t.innerHTML = '';
            if (data.length === 0) {
                t.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px; color:var(--text-muted);">No test questions added yet.</td></tr>';
                return;
            }
            data.forEach(q => {
                const options = ['A', 'B', 'C', 'D'];
                t.innerHTML += `<tr>
                    <td>${q.id}</td>
                    <td><span class="tag" style="background:#e0f2fe; color:#0369a1;">${q.subject}</span></td>
                    <td style="max-width:300px; overflow:hidden; text-overflow:ellipsis;">${q.question}</td>
                    <td><span style="background:#dcfce7; color:#166534; padding:3px 8px; border-radius:6px; font-weight:600;">${options[q.correctIndex]}</span></td>
                    <td style="text-align:center;">
                        <button onclick="editTestQuestion(${q.id})" style="padding:5px 10px; font-size:0.8rem; background:#f59e0b; margin-right:5px;">Edit</button>
                        <button onclick="deleteTestQuestion(${q.id})" style="padding:5px 10px; font-size:0.8rem; background:#ef4444;">Delete</button>
                    </td>
                </tr>`;
            });
        }

        function updateQuestionStats(data) {
            document.getElementById('total-test-questions').textContent = data.length;
            const subjects = [...new Set(data.map(q => q.subject))];
            document.getElementById('total-subjects').textContent = subjects.length;
        }

        function filterTestQuestions() {
            const filter = document.getElementById('filterTestSubject').value;
            const filtered = filter === 'all' ? allTestQuestions : allTestQuestions.filter(q => q.subject === filter);
            renderTestQuestions(filtered);
        }

        document.getElementById('testQuestionForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const id = document.getElementById('tq-id').value;
            const data = {
                subject: document.getElementById('tq-subject').value,
                question: document.getElementById('tq-question').value,
                options: [
                    document.getElementById('tq-opt0').value,
                    document.getElementById('tq-opt1').value,
                    document.getElementById('tq-opt2').value,
                    document.getElementById('tq-opt3').value
                ],
                correctIndex: parseInt(document.getElementById('tq-correct').value)
            };

            const url = id ? '/api/test/update_question' : '/api/test/add_question';
            if (id) data.id = parseInt(id);

            fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            }).then(r => r.json()).then(result => {
                if (result.success) {
                    alert(id ? 'Question updated!' : 'Question added!');
                    resetTestQForm();
                    loadTestQuestions();
                } else {
                    alert('Error: ' + (result.error || 'Unknown error'));
                }
            }).catch(err => alert('Error: ' + err.message));
        });

        function editTestQuestion(id) {
            const q = allTestQuestions.find(x => x.id === id);
            if (!q) return;
            document.getElementById('tq-id').value = q.id;
            document.getElementById('tq-subject').value = q.subject;
            document.getElementById('tq-question').value = q.question;
            document.getElementById('tq-opt0').value = q.options[0];
            document.getElementById('tq-opt1').value = q.options[1];
            document.getElementById('tq-opt2').value = q.options[2];
            document.getElementById('tq-opt3').value = q.options[3];
            document.getElementById('tq-correct').value = q.correctIndex;
            document.getElementById('tq-btn').textContent = 'Update Question';
            document.getElementById('test-form-title').innerHTML = '<i class="bx bx-edit"></i> Edit Question';
        }

        function deleteTestQuestion(id) {
            if (confirm('Are you sure you want to delete this question?')) {
                fetch('/api/test/delete_question?id=' + id).then(r => r.json()).then(result => {
                    if (result.success) {
                        loadTestQuestions();
                    } else {
                        alert('Error deleting question');
                    }
                });
            }
        }

        function resetTestQForm() {
            document.getElementById('testQuestionForm').reset();
            document.getElementById('tq-id').value = '';
            document.getElementById('tq-btn').textContent = 'Add Question';
            document.getElementById('test-form-title').innerHTML = '<i class="bx bx-plus-circle"></i> Add Test Question';
        }

        // Schedule Tests Management
        function loadScheduledTests() {
            fetch('/api/test/scheduled_tests').then(r => r.json()).then(data => {
                allScheduledTests = data;
                renderScheduledTests(data);
                updateTestResultsFilter(data);
            }).catch(err => console.error('Error loading scheduled tests:', err));
        }

        function renderScheduledTests(data) {
            const t = document.querySelector('#scheduledTestsTable tbody');
            t.innerHTML = '';
            if (data.length === 0) {
                t.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:20px; color:var(--text-muted);">No tests scheduled yet.</td></tr>';
                return;
            }
            const now = new Date();
            data.forEach(test => {
                const testDate = new Date(test.scheduledDate + 'T' + test.scheduledTime);
                const endDate = new Date(testDate.getTime() + test.duration * 60000);
                let status, statusColor;
                if (now < testDate) {
                    status = 'Upcoming';
                    statusColor = '#3b82f6';
                } else if (now >= testDate && now <= endDate) {
                    status = 'Active';
                    statusColor = '#10b981';
                } else {
                    status = 'Completed';
                    statusColor = '#6b7280';
                }
                t.innerHTML += `<tr>
                    <td><b>${test.title}</b></td>
                    <td>${test.scheduledDate}</td>
                    <td>${test.scheduledTime}</td>
                    <td>${test.duration} min</td>
                    <td>${test.numQuestions}</td>
                    <td><span style="background:${statusColor}20; color:${statusColor}; padding:4px 10px; border-radius:12px; font-weight:600; font-size:0.85rem;">${status}</span></td>
                    <td style="text-align:center;">
                        <button onclick="editScheduledTest(${test.id})" style="padding:5px 10px; font-size:0.8rem; background:#f59e0b; margin-right:5px;">Edit</button>
                        <button onclick="deleteScheduledTest(${test.id})" style="padding:5px 10px; font-size:0.8rem; background:#ef4444;">Delete</button>
                    </td>
                </tr>`;
            });
        }

        document.getElementById('scheduleTestForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const id = document.getElementById('sched-id').value;
            const data = {
                title: document.getElementById('sched-title').value,
                scheduledDate: document.getElementById('sched-date').value,
                scheduledTime: document.getElementById('sched-time').value,
                duration: parseInt(document.getElementById('sched-duration').value),
                numQuestions: parseInt(document.getElementById('sched-questions').value)
            };

            const url = id ? '/api/test/update_scheduled' : '/api/test/schedule';
            if (id) data.id = parseInt(id);

            fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            }).then(r => r.json()).then(result => {
                if (result.success) {
                    alert(id ? 'Test updated!' : 'Test scheduled!');
                    resetScheduleForm();
                    loadScheduledTests();
                } else {
                    alert('Error: ' + (result.error || 'Unknown error'));
                }
            }).catch(err => alert('Error: ' + err.message));
        });

        function editScheduledTest(id) {
            const test = allScheduledTests.find(x => x.id === id);
            if (!test) return;
            document.getElementById('sched-id').value = test.id;
            document.getElementById('sched-title').value = test.title;
            document.getElementById('sched-date').value = test.scheduledDate;
            document.getElementById('sched-time').value = test.scheduledTime;
            document.getElementById('sched-duration').value = test.duration;
            document.getElementById('sched-questions').value = test.numQuestions;
            document.getElementById('sched-btn').textContent = 'Update Test';
        }

        function deleteScheduledTest(id) {
            if (confirm('Are you sure you want to delete this scheduled test?')) {
                fetch('/api/test/delete_scheduled?id=' + id).then(r => r.json()).then(result => {
                    if (result.success) {
                        loadScheduledTests();
                    } else {
                        alert('Error deleting test');
                    }
                });
            }
        }

        function resetScheduleForm() {
            document.getElementById('scheduleTestForm').reset();
            document.getElementById('sched-id').value = '';
            document.getElementById('sched-duration').value = '30';
            document.getElementById('sched-questions').value = '10';
            document.getElementById('sched-btn').textContent = 'Schedule Test';
        }

        // Test Results Management
        function loadTestResults() {
            fetch('/api/test/results').then(r => r.json()).then(data => {
                allTestResults = data;
                renderTestResults(data);
                updateResultStats(data);
            }).catch(err => console.error('Error loading test results:', err));
        }

        function updateTestResultsFilter(tests) {
            const select = document.getElementById('filterTestResults');
            select.innerHTML = '<option value="all">All Tests</option>';
            tests.forEach(test => {
                select.innerHTML += `<option value="${test.id}">${test.title}</option>`;
            });
        }

        function renderTestResults(data) {
            const t = document.querySelector('#testResultsTable tbody');
            t.innerHTML = '';
            if (data.length === 0) {
                t.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px; color:var(--text-muted);">No test results yet.</td></tr>';
                return;
            }
            data.forEach(r => {
                const scorePercent = Math.round((r.score / r.totalQuestions) * 100);
                const scoreColor = scorePercent >= 70 ? '#16a34a' : (scorePercent >= 50 ? '#f59e0b' : '#ef4444');
                const videoBtnHtml = r.videoPath ? 
                    `<button onclick="playTestVideo('${r.videoPath}', '${r.studentName}')" style="padding:5px 10px; font-size:0.8rem; background:#4f46e5;"><i class='bx bx-play'></i> Watch</button>` :
                    '<span style="color:#9ca3af;">No video</span>';
                t.innerHTML += `<tr>
                    <td><b>${r.studentName}</b><br><span style="font-size:0.8rem; color:#64748b;">${r.student}</span></td>
                    <td>${r.testTitle}</td>
                    <td><span style="background:${scoreColor}20; color:${scoreColor}; padding:4px 10px; border-radius:12px; font-weight:700;">${r.score}/${r.totalQuestions} (${scorePercent}%)</span></td>
                    <td style="color:#64748b; font-size:0.85rem;">${r.completedAt}</td>
                    <td style="color:#64748b; font-size:0.85rem;">${r.timeTaken || '-'}</td>
                    <td style="text-align:center;">${videoBtnHtml}</td>
                </tr>`;
            });
        }

        function updateResultStats(data) {
            document.getElementById('total-tests-taken').textContent = data.length;
            const videosCount = data.filter(r => r.videoPath).length;
            document.getElementById('videos-count').textContent = videosCount;
            if (data.length > 0) {
                const avgScore = data.reduce((sum, r) => sum + (r.score / r.totalQuestions * 100), 0) / data.length;
                document.getElementById('avg-test-score').textContent = Math.round(avgScore) + '%';
            } else {
                document.getElementById('avg-test-score').textContent = '0%';
            }
        }

        function filterTestResults() {
            const filter = document.getElementById('filterTestResults').value;
            const filtered = filter === 'all' ? allTestResults : allTestResults.filter(r => r.testId == filter);
            renderTestResults(filtered);
        }

        function playTestVideo(videoPath, studentName) {
            const modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:9999;display:flex;align-items:center;justify-content:center;';
            modal.innerHTML = `
                <div style="background:white;border-radius:12px;padding:20px;max-width:800px;width:90%;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
                        <h3 style="margin:0;"><i class='bx bx-video'></i> Proctoring Video - ${studentName}</h3>
                        <button onclick="this.closest('div').parentElement.remove()" style="background:none;border:none;font-size:1.5rem;cursor:pointer;">&times;</button>
                    </div>
                    <video controls autoplay style="width:100%;border-radius:8px; background:#000;">
                        <source src="/api/test/video/${videoPath}" type="video/webm">
                        Your browser does not support the video tag.
                    </video>
                </div>
            `;
            modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });
            document.body.appendChild(modal);
        }
        
        loadRoster();
        loadFeedbackBadge();
    </script>
</body>
</html>